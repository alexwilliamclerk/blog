---
import type { CollectionEntry } from "astro:content";
import { getCollection } from "astro:content";

export async function getStaticPaths() {
  const poems = await getCollection("poems");
  return poems.map((p) => ({ params: { slug: p.slug } }));
}

const { slug } = Astro.params;
const poems = await getCollection("poems");

// å½“å‰
const currentIndex = poems.findIndex((p) => p.slug === slug);
if (currentIndex === -1) {
  return new Response("Not found", { status: 404 });
}

const poem = poems[currentIndex];
const { Content } = await poem.render();

// ä¸Šä¸€é¦– / ä¸‹ä¸€é¦–ï¼ˆæŒ‰ date æ’åºæ›´åˆç†ï¼›å¦‚æœä½ æ²¡åšæ’åºï¼Œè¿™é‡Œç”¨åŸæ•°ç»„é¡ºåºï¼‰
// å»ºè®®æŒ‰ date æ–°â†’æ—§æ’åºï¼š
const sorted = [...poems].sort((a, b) => {
  const da = new Date(a.data.date).getTime();
  const db = new Date(b.data.date).getTime();
  return db - da;
});
const idx = sorted.findIndex((p) => p.slug === slug);
const prev = idx > 0 ? sorted[idx - 1] : null; // æ›´æ–°çš„ä¸Šä¸€é¦–ï¼ˆæ›´â€œæ–°â€ï¼‰
const next = idx < sorted.length - 1 ? sorted[idx + 1] : null; // æ›´â€œæ—§â€

const site = Astro.site?.toString().replace(/\/$/, "") ?? "";
const canonical = site ? `${site}/poems/${poem.slug}/` : undefined;
const dateStr = poem?.data?.date ? new Date(poem.data.date).toISOString().slice(0, 10) : "";


const title = poem.data.title;
const date = poem.data.date; // å»ºè®® schema é‡Œæ˜¯ YYYY-MM-DD
const tags: string[] = poem.data.tags ?? [];
const description =
  (poem.data.description as string | undefined) ??
  `${title}ï½œ${date}ï½œè¯—æ­Œ`;

const formatDate = (iso: string) => {
  // iso: 2024-12-04
  // æ˜¾ç¤ºæˆ 2024-12-04ï¼ˆä½ è¦ä¸­æ–‡æ ¼å¼ä¹Ÿå¯ä»¥å†æ”¹ï¼‰
  return iso;
};
---

<!doctype html>
<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />

    <title>{title}ï½œè¯—æ­Œ</title>
    <meta name="description" content={description} />
    {canonical && <link rel="canonical" href={canonical} />}

    <meta data-pagefind-filter="type[content]" content="poem" />
    <meta data-pagefind-meta="title[content]" content={title} />
    <meta data-pagefind-meta="date[content]" content={dateStr} />

    <meta data-pagefind-meta="tags[content]" content={tags.join(", ")} />

    <!-- åŸºç¡€ SEO / ç¤¾äº¤å¡ç‰‡ -->
    <meta property="og:type" content="article" />
    <meta property="og:locale" content="zh_CN" />
    <meta property="og:title" content={`${title}ï½œè¯—æ­Œ`} />
    <meta property="og:description" content={description} />
    {canonical && <meta property="og:url" content={canonical} />}

    <meta name="twitter:card" content="summary" />

    <style>
      :root{
        --bg: #0b0f0c;
        --panel: rgba(255,255,255,0.04);
        --panel2: rgba(255,255,255,0.06);
        --text: rgba(255,255,255,0.92);
        --muted: rgba(255,255,255,0.65);
        --line: rgba(255,255,255,0.10);
        --accent: #7fe0b3; /* æµ…ç»¿è‰² */
        --accent2:#5ccf9c;
        --radius: 18px;
      }

      *{ box-sizing:border-box; }
      body{
        margin:0;
        background: radial-gradient(1200px 800px at 10% 0%, rgba(127,224,179,0.08), transparent 55%),
                    radial-gradient(900px 600px at 90% 10%, rgba(127,224,179,0.06), transparent 60%),
                    var(--bg);
        color:var(--text);
        font-family: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Noto Sans", "Apple Color Emoji", "Segoe UI Emoji";
      }

      a{ color:inherit; text-decoration:none; }
      .wrap{
        max-width: 980px;
        margin: 0 auto;
        padding: 20px 16px 56px;
      }

      /* é¡¶éƒ¨æ ï¼ˆåƒ IG é¡¶æ ï¼šå·¦æ ‡é¢˜ï¼Œä¸­æŒ‰é’®ï¼‰ */
      header.top{
        position: sticky;
        top: 0;
        z-index: 20;
        backdrop-filter: blur(10px);
        background: linear-gradient(to bottom, rgba(11,15,12,0.85), rgba(11,15,12,0.55));
        border-bottom: 1px solid var(--line);
        padding: 14px 0;
      }
      .topInner{
        max-width: 980px;
        margin: 0 auto;
        padding: 0 16px;
        display:flex;
        align-items:center;
        justify-content:space-between;
        gap: 12px;
      }
      .brand{
        display:flex;
        align-items:center;
        gap:10px;
        font-weight: 700;
        letter-spacing: 0.5px;
      }
      .dot{
        width:10px;height:10px;border-radius:999px;
        background: var(--accent);
        box-shadow: 0 0 18px rgba(127,224,179,0.35);
      }
      .nav{
        display:flex;
        gap:10px;
        align-items:center;
      }
      .pill{
        padding: 9px 12px;
        border: 1px solid var(--line);
        border-radius: 999px;
        background: rgba(255,255,255,0.03);
        color: var(--muted);
        font-size: 14px;
      }
      .pill:hover{
        border-color: rgba(127,224,179,0.35);
        color: var(--text);
      }

      /* å¸–å­å¡ç‰‡ */
      .post{
        margin-top: 18px;
        border: 1px solid var(--line);
        background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.02));
        border-radius: var(--radius);
        overflow:hidden;
        box-shadow: 0 16px 50px rgba(0,0,0,0.35);
      }

      .metaRow{
        padding: 18px 18px 14px;
        border-bottom: 1px solid var(--line);
        display:flex;
        flex-direction:column;
        gap:10px;
      }

      .titleRow{
        display:flex;
        align-items:flex-start;
        justify-content:space-between;
        gap: 12px;
      }

      h1{
        margin:0;
        font-size: 22px;
        line-height: 1.2;
      }

      .subRow{
        display:flex;
        gap: 10px;
        flex-wrap:wrap;
        align-items:center;
        color: var(--muted);
        font-size: 14px;
      }

      .tag{
        display:inline-flex;
        gap:6px;
        align-items:center;
        padding: 6px 10px;
        border-radius: 999px;
        border: 1px solid rgba(127,224,179,0.22);
        background: rgba(127,224,179,0.07);
        color: rgba(127,224,179,0.95);
      }

      .content{
        padding: 18px;
      }

      /* è®©è¯—æ­Œæ¢è¡Œä¿ç•™ã€åŒæ—¶æ’ç‰ˆæ›´åƒâ€œå¡ç‰‡æ­£æ–‡â€ */
      .poemBody :global(p){
        margin: 0 0 14px;
        color: rgba(255,255,255,0.88);
      }
      .poemBody{
        white-space: pre-wrap; /* ä¿ç•™æ¢è¡Œ */
        line-height: 1.85;
        font-size: 16px;
        letter-spacing: 0.2px;
      }

      /* åº•éƒ¨å¯¼èˆª */
      .footerNav{
        border-top: 1px solid var(--line);
        padding: 14px 18px 16px;
        display:grid;
        grid-template-columns: 1fr 1fr;
        gap: 12px;
      }
      .navCard{
        border: 1px solid var(--line);
        border-radius: 14px;
        background: rgba(255,255,255,0.03);
        padding: 12px 12px;
        min-height: 64px;
        display:flex;
        flex-direction:column;
        justify-content:center;
        gap: 6px;
      }
      .navCard:hover{
        border-color: rgba(127,224,179,0.35);
      }
      .navHint{
        color: var(--muted);
        font-size: 12px;
      }
      .navTitle{
        font-size: 14px;
        color: var(--text);
      }

      .backRow{
        margin-top: 14px;
        display:flex;
        justify-content:center;
      }
      .backBtn{
        display:inline-flex;
        align-items:center;
        gap: 10px;
        padding: 10px 14px;
        border-radius: 999px;
        border: 1px solid rgba(127,224,179,0.28);
        background: rgba(127,224,179,0.10);
        color: rgba(127,224,179,0.95);
      }
      .backBtn:hover{
        background: rgba(127,224,179,0.14);
      }

      @media (max-width: 640px){
        .footerNav{ grid-template-columns: 1fr; }
        h1{ font-size: 20px; }
      }
    </style>
  </head>

  <body>
    <header class="top">
      <div class="topInner">
        <a class="brand" href="/">
          <span class="dot"></span>
          <span>è¯—æ­Œ</span>
        </a>
        <nav class="nav">
          <a class="pill" href="/poems/">åˆ—è¡¨</a>
          <a class="pill" href="/search/">æœç´¢</a>
        </nav>
      </div>
    </header>

    <main class="wrap">
      <article class="post">
        <div class="metaRow">
          <div class="titleRow">
            <h1>{title}</h1>
          </div>

          <div class="subRow">
            <span>ğŸ—“ {formatDate(date)}</span>
            {tags.length > 0 && (
              <>
                <span>Â·</span>
                {tags.map((t) => <span class="tag">#{t}</span>)}
              </>
            )}
          </div>
        </div>

<div class="content">
  <div class="poemBody poemBody" data-pagefind-body>
    <Content />
  </div>

  <div class="backRow" data-pagefind-ignore>
    <a class="backBtn" href="/poems/">â† è¿”å›è¯—æ­Œåˆ—è¡¨</a>
  </div>
</div>

        <div class="footerNav">
{(() => {
  const prevHref = prev?.slug ? `/poems/${prev.slug}/` : null;
  const nextHref = next?.slug ? `/poems/${next.slug}/` : null;

  return (
    <>
      {prevHref ? (
        <a class="navCard" href={prevHref}>
          <div class="navHint">ä¸Šä¸€é¦–ï¼ˆæ›´æ–°ï¼‰</div>
          <div class="navTitle">{prev?.data?.title ?? "æ— æ ‡é¢˜"}</div>
        </a>
      ) : (
        <div class="navCard" aria-hidden="true">
          <div class="navHint">ä¸Šä¸€é¦–</div>
          <div class="navTitle">æ²¡æœ‰äº†</div>
        </div>
      )}

      {nextHref ? (
        <a class="navCard" href={nextHref}>
          <div class="navHint">ä¸‹ä¸€é¦–ï¼ˆæ›´æ–°ï¼‰</div>
          <div class="navTitle">{next?.data?.title ?? "æ— æ ‡é¢˜"}</div>
        </a>
      ) : (
        <div class="navCard" aria-hidden="true">
          <div class="navHint">ä¸‹ä¸€é¦–</div>
          <div class="navTitle">æ²¡æœ‰äº†</div>
        </div>
      )}
    </>
  );
})()}
        </div>
      </article>
    </main>
  </body>
</html>
