<html lang="zh-CN">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>搜索</title>

    <style>
      :root{
        --bg:#0f1115;
        --card:#151821;
        --border:rgba(255,255,255,.08);
        --text:#e6e6e6;
        --muted:rgba(255,255,255,.55);
        --accent:#7ef29a;
      }
      body{
        margin:0;
        background:var(--bg);
        color:var(--text);
        font-family:system-ui,-apple-system,BlinkMacSystemFont,Segoe UI,Roboto,Helvetica,Arial;
      }
      .wrap{
        max-width:1100px;
        margin:0 auto;
        padding:32px 20px 70px;
      }
      .nav{
        display:flex;
        gap:18px;
        margin-bottom:36px;
      }
      .nav a{
        color:var(--muted);
        text-decoration:none;
        font-size:14px;
      }
      .nav a.active{ color:var(--accent); }

      h1{ margin:0 0 12px; font-size:28px; }
      .desc{ color:var(--muted); margin:0 0 18px; font-size:14px; }

      .input{
        width:100%;
        max-width:680px;
        padding:12px 14px;
        border-radius:14px;
        border:1px solid var(--border);
        background:rgba(255,255,255,.03);
        color:var(--text);
        outline:none;
      }
      .input:focus{
        border-color:rgba(126,242,154,.6);
        box-shadow:0 0 0 3px rgba(126,242,154,.12);
      }

$q.addEventListener("keydown", (e) => {
  if (e.key === "Enter") searchNow();
});

      .list{ margin-top:18px; display:grid; gap:12px; }
      .item{
        display:block;
        background:var(--card);
        border:1px solid var(--border);
        border-radius:16px;
        padding:14px 16px;
        text-decoration:none;
        color:inherit;
      }
      .item:hover{ border-color:var(--accent); }
      .title{ font-weight:600; font-size:16px; }
      .meta{ color:var(--muted); font-size:13px; margin-top:6px; }
      .empty{
        background:var(--card);
        border:1px solid var(--border);
        border-radius:16px;
        padding:18px;
        color:var(--muted);
        line-height:1.7;
        margin-top:18px;
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="nav">
        <a href="/">首页</a>
        <a href="/poems/">诗歌</a>
        <a href="/photos/">摄影</a>
        <a href="/search/" class="active">搜索</a>
      </div>

      <h1>搜索</h1>
      <p class="desc">支持全文搜索（Pagefind）。请在 preview/线上测试。</p>

      <input id="q" class="input" placeholder="输入关键词（将搜索正文）" />

      <div id="list" class="list"></div>
      <div id="hint" class="empty" style="display:none;"></div>

      <script>
        const $q = document.getElementById("q");
        const $list = document.getElementById("list");
        const $hint = document.getElementById("hint");

        function showHint(html) {
          $hint.style.display = "block";
          $hint.innerHTML = html;
        }

        function clearHint() {
          $hint.style.display = "none";
          $hint.innerHTML = "";
        }

async function ensurePagefind() {
  if (window.pagefind) return;

  await new Promise((resolve, reject) => {
    const s = document.createElement("script");
    s.type = "module";
    // 关键：用内联 module 把 pagefind 导入并挂到 window.pagefind
    s.textContent = `
      import * as pf from "/pagefind/pagefind.js";
      window.pagefind = pf;
    `;
    s.onload = resolve;
    s.onerror = reject;
    document.head.appendChild(s);
  });

  if (!window.pagefind) throw new Error("pagefind still missing");
}

        function renderLinks(rows) {
          if (rows.length === 0) {
            $list.innerHTML = "";
            showHint("没有结果。换个关键词试试。");
            return;
          }
          clearHint();
          $list.innerHTML = rows
            .map(
              (r) => `
              <a class="item" href="${r.url}">
                <div class="title">${r.title}</div>
                <div class="meta">${r.url}</div>
              </a>`
            )
            .join("");
        }

        async function searchNow() {
          const q = $q.value.trim();
          if (!q) {
            $list.innerHTML = "";
            showHint("输入关键词开始搜索（会搜索正文）。");
            return;
          }

          await ensurePagefind();

          const res = await window.pagefind.search(q);
          const out = [];

          // 先只做最小版：标题 + 链接
          for (const r of res.results.slice(0, 20)) {
            const data = await r.data();
            const title = data?.meta?.title || data?.meta?.title?.content || data?.url || "Untitled";
            out.push({ title, url: data.url });
          }

          renderLinks(out);
        }

        let t = null;
        $q.addEventListener("input", () => {
          clearTimeout(t);
          t = setTimeout(searchNow, 200);
        });

        showHint("输入关键词开始搜索（会搜索正文）。");
      </script>
    </div>
  </body>
</html>
